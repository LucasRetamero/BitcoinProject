{% extends 'base.html' %}
{% load steptimetags %}
{% load static %}

{% block content %}
<main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Dashboard - Desenvolvimento do Bitcoin</h1>
            <!--<div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group mr-2">
                <button class="btn btn-sm btn-outline-secondary">Share</button>
                <button class="btn btn-sm btn-outline-secondary">Export</button>
              </div>
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle">
                <span data-feather="calendar"></span>
                This week
              </button>
            </div>-->
          </div>

<div class="card" style="margin-bottom: 25px;">
  <div class="card-header bg-primary text-white h4" onclick="showHideGraph('#myChart', '#optionPrice')">
    Pesquisar desenvolvimento do Bitcoin pela data
  </div>
  <div id="msgOutputSearchDevError" class="alert alert-danger" role="alert" style="display: none;">
  <center><b>Operação não realizada !</b></center><br>
   Preencha todos os campos antes de continuar:
  <ul>
  <li class="emptyDayField"><b>Campo <i>Dia</i> não selecionado</b></li>
  <li class="emptyMonthField"><b>Campo <i>Mês</i> não selecionado </b></li>
  <li class="emptyYearField"><b>Campo <i>Ano</i> não selecionado </b></li>
  <li class="emptyQuantyField"><b>Campo <i>Quantidade</i> não selecionado </b></li>
  </ul>
</div>
<div id="msgOutputSearchDevSuccess" class="alert alert-success" role="alert" style="display: none;">
  <center><b>Operação realizada com sucesso !</b><br>
   <a href="#listDevBtc">Ver resultado da pesquisa !</a></center>
</div>
  <div class="row">
  <div class="col-3">
    <label for="exampleFormControlSelect1">Dia</label>
    <select class="form-control" id="txtDay" required>
     <option value="Default" selected>Dia</option>
	</select>
  </div>
   <div class="col-3">
    <label for="exampleFormControlSelect1">Mês</label>
    <select class="form-control" id="txtMonth" required>
      <option value="Default" selected>Mês</option>
    </select>
  </div>
   <div class="col-3">
    <label for="exampleFormControlSelect1">Ano</label>
    <select class="form-control" id="txtYear" required>
      <option value="Default" selected>Ano</option>
    </select>
  </div>
  <div class="col-3">
    <label for="exampleFormControlSelect1">Quantidade</label>
    <select class="form-control" id="txtQtty" required>
      <option value="Default" selected>Quantidade</option>
    </select>
  </div>
  </div>
  <button type="button" class="btn btn-lg btn-primary text-white w-50 mx-auto" id="btnCheckDevPrice" style="margin-top: 15px;"><span data-feather="check-square" style="width: 25px;height: 25px;"></span> Verificar desenvolvimento</button>
 </div>
 
<div class="card" id="devBtc">
  <div class="card-header bg-primary text-white h4" onclick="showAndHide('#DevelopmentBtc', '#optionDevPrice')">
    Desenvolvimento do Bitcoin  <span id="optionDevPrice" style="float: right;font-weight: bold;">-</span>
  </div>
 <canvas class="my-4 w-100" id="DevelopmentBtc" width="900" height="380"></canvas>
</div>

<div class="card" id="listDevBtc" style="display: none;">
  <div class="card-header bg-primary text-white h4" onclick="showAndHide('#tbDevBtcFromApi', '#lblDevFromApi')">
    Resultado da pesquisa <span id="lblDevFromApi" style="float: right;font-weight: bold;">-</span>
  </div>
  <div id="tbDevBtcFromApi" class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Data Inicial</th>
                  <th>Data Final</th>
                  <th>Quantidade</th>
                  <th>Menu</th>
                </tr>
              </thead>
              <tbody>
               <tr>
              <td id="txtTimeFrom"><!--{{ valueDev.Data.TimeFrom|print_timestamp|date:"d-m-Y" }}--></td>
              <td id="txtTimeTo"><!--{{ valueDev.Data.TimeTo|print_timestamp|date:"d-m-Y" }}--></td>
              <td id="txtQuantity"><!--{{ valueDev.Data.TimeTo|print_timestamp|date:"d-m-Y" }}--></td>
              <td><button id="btnSaveAllDevelopment" type="button" class="btn btn-primary text-white"><span data-feather="plus-square" style="width: 20px;height: 20px;"></span> Salvar Todos</button></td>
			  </tr>
			   <table id="tbListDevPrice" class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Fechamento</th>
                  <th>Volume</th>
                  <th>Menu</th>
                </tr>
              </thead>
              <tbody>
			   <!--{% for val in valueDev.Data.Data %}
               <tr>
              <td>{{ val.time|print_timestamp|date:"d-m-Y"  }}</td>
              <td>{{ val.close  }}</td>
              <td>{{ val.volumefrom  }}</td>
                </tr>
                 {% endfor %}-->
                </tbody>
               </table>
              </tbody>
            </table>
          </div>
 </div>

<div class="card" id="listDevBtcFromDB">
  <div class="card-header bg-primary text-white h4" onclick="showAndHide('#tbDevBtcFromDb', '#lblDevFromDb')">
    Lista do desenvolvimento do Bitcoin <span id="lblDevFromDb" style="float: right;font-weight: bold;">-</span>
  </div>
  <div id="tbDevBtcFromDb"class="table-responsive">
            <table id="tbDevBtcToPage"class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Ultimo</th>
                  <th>Volume</th>
                  <th>Menu</th>
                </tr>
              </thead>
              <tbody>
			  {% for valueDev in allData %}
               <tr>
              <td class="txtDateToUpdate">{{ valueDev.data|date:"d-m-Y" }}</td>
              <td class="txtCloseToUpdate">{{ valueDev.ultimo }}</td>
              <td class="txtVolumeToUpdate">{{ valueDev.volume }}</td>
              <td><button type="button" class="btn btn-warning btnUpdateDevBtc"><span data-feather="edit"></span> Atualizar</button>
			      <button type="button" class="btn btn-danger btnRemoveDevBtc"><span data-feather="trash-2"></span> Remover</button>
              </td>
			  </tr>
			  {% endfor %}
			  </tbody>
            </table>
          </div>
 </div>
 <div class="modal fade" id="infomationModel" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"><!-- Here the text--></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="msgOutput" style="font-size:15px;"><!-- Text here --></p>
      </div>
      <div id="btnAction" class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal"><span data-feather="x-square"></span> Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="infomationModel" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"><!-- Here the text--></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="msgOutput" style="font-size:15px;"><!-- Text here --></p>
      </div>
      <div id="btnAction" class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal"><span data-feather="x-square"></span> Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation save all data -->
<div class="modal fade" id="askSaveAllModel" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Realizar operação de cadastro ?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="msgOutput" style="font-size:15px;">Deseja realmente cadastrar todos os dados da tabela ?</p>
      </div>
      <div id="btnAction" class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal"><span data-feather="x-square"></span> Fechar</button>
        <button id="btnSaveAllDataToDB" type="button" class="btn btn-success" data-dismiss="modal"><span data-feather="plus-square"></span> Salvar Todos</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation remove data -->
<div class="modal fade" id="askRemoveAllModel" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Realizar operação de cadastro ?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p style="font-size:15px;">Deseja realmente remover a data: <b><label id="lblDataToRemove"></label></b> ?</p>
      </div>
      <div id="btnAction" class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal"><span data-feather="x-square"></span> Fechar</button>
        <button id="btnRemoveFromDB" type="button" class="btn btn-danger" data-dismiss="modal"><span data-feather="trash-2"></span> Remover</button>
      </div>
    </div>
  </div>
</div>

<!-- Update Form -->
<div class="modal fade" id="infomationModelToUpdate" tabindex="-1" role="dialog"  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><b>Atualizar Preço</b></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
	  <div id="msgOutputUpdError" class="alert alert-danger" role="alert" style="display: none;">
  <center>Operação não realizada !</center><br>
   Preencha todos os campos antes de continuar:
  <ul>
  <li class="emptyPriceField"><b>Campo <i>Preço</i> vazio </b></li>
  <li class="emptyVolumeField"><b>Campo <i>Volume</i> vazio </b></li>
  </ul>
</div>
<div id="msgOutputUpdSuccess" class="alert alert-success" role="alert" style="display: none;">
  <center><b>Operação realizada com sucesso !</b><br>
   Todos os dados foram atualizados !</center>
</div>

      <div id="formToUpdate" class="modal-body">
	   <i>* = Campo editavel</i>
  <div class="form-group">
    <label for="txtDateUpdate">Data</label>
    <input type="text" class="form-control" id="txtDateUpdate">
  </div>
  <div class="form-group">
    <label for="txtPriceUpdate">Preço(*)</label>
    <input type="text" class="form-control" id="txtPriceUpdate">
  </div>
  <div class="form-group">
    <label for="txtVolumeUpdate">Volume(*)</label>
    <input type="text" class="form-control" id="txtVolumeUpdate">
  </div>
    <div class="form-group">
     <label for="txtPriceUpdate">Resultado Preço</label>
     <input type="text" class="form-control" id="txtOutputPriceUpdate" style="background-color: #FFF" readonly>
	</div>
      </div>
      <div id="addButtonsUpdate" class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal"><span data-feather="x-square"></span> Fechar</button>
        <button id="btnActionUpdateDevBtc" type="button" class="btn btn-warning"><span data-feather="edit"></span> Atualizar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
 
{% block javascript %} 
<script src="{% static 'js/developmentBitcoin/changeFrontEnd.js' %}"></script>     
<script src="{% static 'js/developmentBitcoin/event.js' %}"></script>     
<script src="{% static 'js/developmentBitcoin/graphic.js' %}"></script>     
<script src="{% static 'js/developmentBitcoin/setAndGet.js' %}"></script>     
<script src="{% static 'js/developmentBitcoin/validation.js' %}"></script>     
<script src="{% static 'js/formatValues.js' %}"></script>
<script type="text/javascript">

//DAO: Get all data from database
function getAllDevelopmentBitcoin(){
    $.ajax({
        url: "{% url 'DevelopmentAllData' %}",
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            var event_data = '<tbody>';
			var mainObj = JSON.parse(data.dataBtc);
			$('#tbDevBtcToPage').find('tbody').remove();
			 for(i = 0;i < mainObj.length; i++){
			  var d = new Date(mainObj[i]["fields"]["data"]);
				event_data += '<tr>';
                event_data += '<td class="txtDateToUpdate">'+("0" + (d.getDate() + 1)).slice(-2)+"/"+("0" + (d.getMonth() + 1)).slice(-2) + "/" + d.getFullYear()+'</td>';
                event_data += '<td class="txtCloseToUpdate">'+mainObj[i]["fields"]["ultimo"]+'</td>';
                event_data += '<td class="txtVolumeToUpdate">'+mainObj[i]["fields"]["volume"]+'</td>';
                event_data += '<td><button type="button" class="btn btn-warning btnUpdateDevBtc"><span data-feather="edit"></span> Editar</button></td>';
                event_data += '<td><button type="button" class="btn btn-danger btnRemoveDevBtc"><span data-feather="trash-2"></span> Remover</button></td>';
                event_data += '</tr>';
			 }
			 event_data += '</tbody>';
            $("#tbDevBtcToPage").append(event_data);
			feather.replace();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from database.");
        }
    });
}

//DAO: Search development of bitcoin 
function getListDevBtc(limit, date){
    $.ajax({
        url: "{% url 'DevelopmentSearchApi' %}",
		data: {
          'toLimit': limit,
		  'toTs': date
        },
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            setInfoTableFromApi(convertTimestampToDate(data.devPrice.Data.TimeFrom, 1), convertTimestampToDate(data.devPrice.Data.TimeTo, 1), data.devPrice.Data.Data.length);
			createBodyFromListDevBtc(data.devPrice.Data.Data);			
			if(!$("#listDevBtc").is(":visible")){ $("#listDevBtc").css({'display': 'block'}); }
			showMsgOnSearchDevPrice(1);
			getDateUpdateGraphDevBtc();
			getAllDevelopmentBitcoin();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//DAO: Send data by parameter and do searching(server-side) to save in the database
function setSaveAllListDevBtc(limit, date){
    $.ajax({
        url: "{% url 'DevelopmentSaveAll' %}",
		data: {
          'toLimit': limit,
		  'toTs': date
        },
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            if(data.saved){ setTitleAndMsgInformationModel("Operação realizada com successo !", "Todos os dados foram salvos com sucesso !"); }
			getDateUpdateGraphDevBtc();
			getAllDevelopmentBitcoin();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//DAO: Send data by parameter and save in the database
function setSaveListDevBtc(date, close, volume){
    $.ajax({
        url: "{% url 'DevelopmentSave' %}",
		data: {
          'date': date,
		  'close': close,
		  'volume': volume
        },
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            if(data.saved){ setTitleAndMsgInformationModel("Operação realizada com sucesso !", "Dados salvo com sucesso !"); }
			getDateUpdateGraphDevBtc();
			getAllDevelopmentBitcoin();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//DAO: Send data by parameter and update in the database
function setUpdateListDevBtc(date, close, volume){
    $.ajax({
        url: "{% url 'DevelopmentSave' %}",
		data: {
          'date': date,
		  'close': close,
		  'volume': volume
        },
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            if(data.saved){  }
			getDateUpdateGraphDevBtc();
			getAllDevelopmentBitcoin();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//DAO: Get data from database to send in the graphic
function getDateUpdateGraphDevBtc(){
    $.ajax({
        url: "{% url 'DevelopmentAllDataToGraphic' %}",
		data: {},
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            showGraph( data.date, data.close, data.volume );
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//DAO: remove data from database
function setRemoveDateDevBtc(date){
    $.ajax({
        url: "{% url 'DevelopmentRemove' %}",
		data: {
		'date' : date,
		},
        dataType: 'json',
        type: 'get',
        cache:false,
        success: function(data){
            //console.log(data);
            if(data.deleted){ setTitleAndMsgInformationModel("Operação realizada com sucesso !", "Dado removido com sucesso !"); }			
			getDateUpdateGraphDevBtc();
			getAllDevelopmentBitcoin();
        },
        error: function(d){
            /*console.log("error");*/
            alert("404. Please wait load from api.");
        }
    });
}

//Load graphic
showGraph('{{ dates|safe }}', '{{ closes|safe }}', '{{ volumes|safe }}');
</script>     
{% endblock %}
